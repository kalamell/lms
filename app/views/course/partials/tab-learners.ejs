<div class="row">
  <!-- Current Positions -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header d-flex justify-content-between align-items-center">
        <h5 class="card-title mb-0">
          <i class="icon-base ri ri-group-line me-2"></i>ตำแหน่งที่เข้าเรียนได้
        </h5>
        <span class="badge bg-primary" id="position-count"><%= coursePositions?.length || 0 %></span>
      </div>
      <div class="card-body">
        <div id="selected-positions" style="max-height: 500px; overflow-y: auto;">
          <% if (coursePositions && coursePositions.length > 0) { %>
            <% coursePositions.forEach(pos => { %>
            <div class="position-item selected d-flex align-items-center justify-content-between mb-2" data-id="<%= pos.position_id %>">
              <span><i class="icon-base ri ri-user-line me-2"></i><%= pos.position_name %></span>
              <button type="button" class="btn btn-sm btn-outline-danger" onclick="removePosition(<%= pos.position_id %>)">
                <i class="icon-base ri ri-close-line"></i>
              </button>
            </div>
            <% }) %>
          <% } else { %>
            <div class="text-center text-muted py-5" id="no-positions-message">
              <i class="icon-base ri ri-group-line" style="font-size: 3rem;"></i>
              <p class="mt-2 mb-0">ยังไม่มีตำแหน่งที่กำหนด</p>
              <p class="small">เลือกตำแหน่งจากด้านขวา</p>
            </div>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- All Positions -->
  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="icon-base ri ri-list-check me-2"></i>รายการตำแหน่งทั้งหมด
        </h5>
      </div>
      <div class="card-body">
        <div class="mb-3">
          <input type="text" class="form-control" id="position-search" placeholder="ค้นหาตำแหน่ง...">
        </div>

        <div class="mb-3">
          <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllPositions()">
            <i class="icon-base ri ri-checkbox-multiple-line me-1"></i>เลือกทั้งหมด
          </button>
          <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllPositions()">
            <i class="icon-base ri ri-close-circle-line me-1"></i>ยกเลิกทั้งหมด
          </button>
        </div>

        <div id="all-positions" style="max-height: 400px; overflow-y: auto;">
          <% allPositions.forEach(pos => { %>
            <% const isSelected = positionIds.includes(pos.id); %>
            <div class="form-check position-check mb-2" data-id="<%= pos.id %>" data-name="<%= pos.name %>">
              <input class="form-check-input position-checkbox" type="checkbox" value="<%= pos.id %>"
                     id="pos-<%= pos.id %>" <%= isSelected ? 'checked' : '' %>>
              <label class="form-check-label" for="pos-<%= pos.id %>">
                <%= pos.name %>
              </label>
            </div>
          <% }) %>
        </div>

        <div class="mt-3">
          <button type="button" class="btn btn-primary w-100" onclick="savePositions()">
            <i class="icon-base ri ri-save-line me-2"></i>บันทึกการเปลี่ยนแปลง
          </button>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// Position search/filter
document.getElementById('position-search').addEventListener('input', function(e) {
  const keyword = e.target.value.toLowerCase();
  document.querySelectorAll('#all-positions .position-check').forEach(el => {
    const name = el.dataset.name.toLowerCase();
    el.style.display = name.includes(keyword) ? '' : 'none';
  });
});

// Select all visible positions
function selectAllPositions() {
  document.querySelectorAll('#all-positions .position-check:not([style*="display: none"]) .position-checkbox').forEach(cb => {
    cb.checked = true;
  });
}

// Deselect all positions
function deselectAllPositions() {
  document.querySelectorAll('#all-positions .position-checkbox').forEach(cb => {
    cb.checked = false;
  });
}

// Remove single position
function removePosition(positionId) {
  const checkbox = document.getElementById('pos-' + positionId);
  if (checkbox) {
    checkbox.checked = false;
  }
  savePositions();
}

// Save positions
function savePositions() {
  const positionIds = Array.from(document.querySelectorAll('.position-checkbox:checked')).map(cb => parseInt(cb.value));

  fetch('/course/api/' + courseId + '/positions/sync', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ positionIds })
  })
  .then(r => r.json())
  .then(res => {
    if (res.success) {
      location.reload();
    } else {
      alert('Error: ' + res.error);
    }
  });
}
</script>
