<!-- Filters -->
<div class="d-flex justify-content-between align-items-center mb-4">
  <h4 class="mb-0">
    <i class="ri ri-dashboard-line me-2"></i>Dashboard Overview
    <% if (selectedCompany === 'makro') { %>
    <span class="badge bg-warning ms-2">Makro</span>
    <% } else if (selectedCompany === 'lotus') { %>
    <span class="badge bg-success ms-2">Lotus</span>
    <% } else { %>
    <span class="badge bg-secondary ms-2">All</span>
    <% } %>
  </h4>
  <div class="d-flex align-items-center gap-3">
    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0">Company:</label>
      <select class="form-select form-select-sm" style="width: auto;" id="companyFilter">
        <option value="lotus" <%= selectedCompany === 'lotus' ? 'selected' : '' %>>Lotus</option>
        <option value="makro" <%= selectedCompany === 'makro' ? 'selected' : '' %>>Makro</option>
        <option value="all" <%= selectedCompany === 'all' ? 'selected' : '' %>>All</option>
      </select>
    </div>
    <div class="d-flex align-items-center gap-2">
      <label class="form-label mb-0">Year:</label>
      <select class="form-select form-select-sm" style="width: auto;" id="yearFilter">
        <% availableYears.forEach(year => { %>
        <option value="<%= year %>" <%= year === selectedYear ? 'selected' : '' %>><%= year %></option>
        <% }) %>
      </select>
    </div>
  </div>
</div>
<script>
document.getElementById('companyFilter').addEventListener('change', updateFilters);
document.getElementById('yearFilter').addEventListener('change', updateFilters);
function updateFilters() {
  const company = document.getElementById('companyFilter').value;
  const year = document.getElementById('yearFilter').value;
  window.location.href = '?company=' + company + '&year=' + year;
}
</script>

<!-- Stats Overview Cards -->
<div class="row g-6 mb-6">
  <!-- Total Users -->
  <div class="col-sm-6 col-xl-3">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <span class="d-block mb-1 text-muted">Total Users</span>
            <h3 class="card-title mb-1"><%= stats.users.total.toLocaleString() %></h3>
            <div class="d-flex gap-2">
              <span class="badge bg-label-info"><%= stats.users.active.toLocaleString() %> Active</span>
              <span class="badge bg-label-warning"><%= stats.users.admins.toLocaleString() %> Admins</span>
            </div>
          </div>
          <div class="avatar">
            <span class="avatar-initial rounded bg-label-primary">
              <i class="ri ri-user-line ri-24px"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Total Learning Records -->
  <div class="col-sm-6 col-xl-3">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <span class="d-block mb-1 text-muted">Learning Records (<%= selectedYear %>)</span>
            <h3 class="card-title mb-1"><%= stats.learning.total.toLocaleString() %></h3>
            <div class="d-flex gap-2">
              <span class="badge bg-label-success"><%= stats.learning.completed.toLocaleString() %> Completed</span>
            </div>
          </div>
          <div class="avatar">
            <span class="avatar-initial rounded bg-label-info">
              <i class="ri ri-book-open-line ri-24px"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Courses -->
  <div class="col-sm-6 col-xl-3">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <span class="d-block mb-1 text-muted">Total Courses</span>
            <h3 class="card-title mb-1"><%= stats.courses.total.toLocaleString() %></h3>
            <div class="d-flex gap-2">
              <span class="badge bg-label-primary"><%= stats.courses.active.toLocaleString() %> Active</span>
            </div>
          </div>
          <div class="avatar">
            <span class="avatar-initial rounded bg-label-success">
              <i class="ri ri-graduation-cap-line ri-24px"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Completion Rate -->
  <div class="col-sm-6 col-xl-3">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between">
          <div>
            <span class="d-block mb-1 text-muted">Completion Rate (<%= selectedYear %>)</span>
            <h3 class="card-title mb-1"><%= stats.completionRate %>%</h3>
            <div class="d-flex gap-2">
              <span class="badge bg-label-info">Avg. Posttest: <%= stats.learning.avgPosttest || '-' %></span>
            </div>
          </div>
          <div class="avatar">
            <span class="avatar-initial rounded bg-label-warning">
              <i class="ri ri-check-double-line ri-24px"></i>
            </span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Charts Row -->
<div class="row g-6 mb-6">
  <!-- Monthly Activity Chart -->
  <div class="col-12">
    <div class="card">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="card-title mb-0">
          <i class="ri ri-line-chart-line me-2"></i>Monthly Learning Activity
        </h5>
        <span class="badge bg-label-primary"><%= selectedYear %></span>
      </div>
      <div class="card-body" style="height: 300px;">
        <canvas id="monthlyChart"></canvas>
      </div>
    </div>
  </div>
</div>

<!-- Top Courses & Recent Completions -->
<div class="row g-6">
  <!-- Top Courses -->
  <div class="col-xl-6">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="card-title mb-0">
          <i class="ri ri-trophy-line me-2"></i>Top Courses (<%= selectedYear %>)
        </h5>
      </div>
      <div class="card-body">
        <% if (topCourses && topCourses.length > 0) { %>
        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>#</th>
                <th>Course</th>
                <th class="text-end">Enrollments</th>
                <th class="text-end">Completed</th>
                <th class="text-end">Avg. Score</th>
              </tr>
            </thead>
            <tbody>
              <% topCourses.forEach((course, index) => { %>
              <tr>
                <td><span class="badge bg-label-<%= index < 3 ? 'primary' : 'secondary' %>"><%= index + 1 %></span></td>
                <td>
                  <div class="text-truncate" style="max-width: 200px;" title="<%= course.course_name || '-' %>">
                    <%= course.course_name || '-' %>
                  </div>
                </td>
                <td class="text-end"><%= Number(course.total_enrollments).toLocaleString() %></td>
                <td class="text-end">
                  <span class="text-success"><%= Number(course.completed_count).toLocaleString() %></span>
                </td>
                <td class="text-end">
                  <% if (course.avg_posttest) { %>
                  <span class="badge bg-label-info"><%= course.avg_posttest %></span>
                  <% } else { %>
                  <span class="text-muted">-</span>
                  <% } %>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <% } else { %>
        <div class="text-center py-4 text-muted">
          <i class="ri ri-folder-line ri-2x mb-2"></i>
          <p class="mb-0">No course data available for <%= selectedYear %></p>
        </div>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Recent Completions -->
  <div class="col-xl-6">
    <div class="card h-100">
      <div class="card-header d-flex align-items-center justify-content-between">
        <h5 class="card-title mb-0">
          <i class="ri ri-medal-line me-2"></i>Recent Completions (<%= selectedYear %>)
        </h5>
      </div>
      <div class="card-body">
        <% if (recentCompletions && recentCompletions.length > 0) { %>
        <div class="table-responsive">
          <table class="table table-sm table-hover">
            <thead>
              <tr>
                <th>User</th>
                <th>Course</th>
                <th class="text-center">Score</th>
                <th>Completed</th>
              </tr>
            </thead>
            <tbody>
              <% recentCompletions.forEach(item => { %>
              <tr>
                <td>
                  <div class="d-flex align-items-center">
                    <div class="avatar avatar-xs me-2">
                      <span class="avatar-initial rounded-circle bg-label-<%= item.company === 'makro' ? 'warning' : 'success' %>">
                        <%= (item.first_name || item.name_thai || 'U').charAt(0).toUpperCase() %>
                      </span>
                    </div>
                    <div>
                      <a href="/user/<%= item.user_id %>" class="text-body fw-medium">
                        <%= item.employee_id || '-' %>
                      </a>
                    </div>
                  </div>
                </td>
                <td>
                  <div class="text-truncate" style="max-width: 150px;" title="<%= item.course_name || '-' %>">
                    <%= item.course_name || '-' %>
                  </div>
                </td>
                <td class="text-center">
                  <% if (item.posttest !== null) { %>
                  <span class="badge bg-label-primary"><%= item.posttest %></span>
                  <% } else if (item.score !== null) { %>
                  <span class="badge bg-label-info"><%= item.score %></span>
                  <% } else { %>
                  <span class="text-muted">-</span>
                  <% } %>
                </td>
                <td>
                  <small class="text-muted">
                    <%= item.updated_at ? new Date(item.updated_at).toLocaleDateString('th-TH') : '-' %>
                  </small>
                </td>
              </tr>
              <% }) %>
            </tbody>
          </table>
        </div>
        <% } else { %>
        <div class="text-center py-4 text-muted">
          <i class="ri ri-file-list-line ri-2x mb-2"></i>
          <p class="mb-0">No completions for <%= selectedYear %></p>
        </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<!-- Learning Status Summary -->
<div class="row g-6 mt-4">
  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h5 class="card-title mb-0">
          <i class="ri ri-dashboard-line me-2"></i>Learning Status Summary (<%= selectedYear %>)
        </h5>
      </div>
      <div class="card-body">
        <div class="row g-4">
          <div class="col-md-3 col-6">
            <div class="d-flex align-items-center">
              <div class="avatar me-3">
                <span class="avatar-initial rounded bg-label-success">
                  <i class="ri ri-check-line"></i>
                </span>
              </div>
              <div>
                <h6 class="mb-0"><%= stats.learning.completed.toLocaleString() %></h6>
                <small class="text-muted">Completed</small>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="d-flex align-items-center">
              <div class="avatar me-3">
                <span class="avatar-initial rounded bg-label-info">
                  <i class="ri ri-loader-line"></i>
                </span>
              </div>
              <div>
                <h6 class="mb-0"><%= stats.learning.inProgress.toLocaleString() %></h6>
                <small class="text-muted">In Progress</small>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="d-flex align-items-center">
              <div class="avatar me-3">
                <span class="avatar-initial rounded bg-label-warning">
                  <i class="ri ri-time-line"></i>
                </span>
              </div>
              <div>
                <h6 class="mb-0"><%= stats.learning.pendingReview.toLocaleString() %></h6>
                <small class="text-muted">Pending Review</small>
              </div>
            </div>
          </div>
          <div class="col-md-3 col-6">
            <div class="d-flex align-items-center">
              <div class="avatar me-3">
                <span class="avatar-initial rounded bg-label-primary">
                  <i class="ri ri-bar-chart-line"></i>
                </span>
              </div>
              <div>
                <h6 class="mb-0"><%= stats.learning.avgPretest || '-' %> / <%= stats.learning.avgPosttest || '-' %></h6>
                <small class="text-muted">Avg. Pre/Post Test</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Monthly Activity Chart
  const monthlyCtx = document.getElementById('monthlyChart');
  if (monthlyCtx) {
    const monthlyData = <%- JSON.stringify(monthlyData) %>;
    const labels = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];

    new Chart(monthlyCtx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
          {
            label: 'Enrollments',
            data: monthlyData.map(d => d.enrollments),
            backgroundColor: 'rgba(105, 108, 255, 0.5)',
            borderColor: 'rgb(105, 108, 255)',
            borderWidth: 1
          },
          {
            label: 'Completions',
            data: monthlyData.map(d => d.completions),
            backgroundColor: 'rgba(113, 221, 55, 0.5)',
            borderColor: 'rgb(113, 221, 55)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'top'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: {
              callback: function(value) {
                return value.toLocaleString();
              }
            }
          }
        }
      }
    });
  }

});
</script>
