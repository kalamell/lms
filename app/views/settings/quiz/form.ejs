<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="/settings">Settings</a></li>
    <li class="breadcrumb-item"><a href="/settings/quiz">Quiz</a></li>
    <li class="breadcrumb-item active"><%= action === 'create' ? 'Create' : 'Edit' %></li>
  </ol>
</nav>

<form method="post" action="<%= action === 'create' ? '/settings/quiz/create' : `/settings/quiz/${quiz.id}/edit` %>">
  <div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
      <!-- Basic Info -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0">
            <i class="ri ri-questionnaire-line me-2"></i>
            <%= action === 'create' ? 'Create Quiz' : 'Edit Quiz' %>
          </h5>
        </div>
        <div class="card-body">
          <div class="mb-4">
            <label class="form-label" for="title">Quiz Title <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="title" name="title"
                   value="<%= quiz?.title || '' %>" required placeholder="Enter quiz title">
          </div>

          <div class="mb-4">
            <label class="form-label" for="course_id">Course <span class="text-danger">*</span></label>
            <select class="form-select" id="course_id" name="course_id" required>
              <option value="">Select Course</option>
              <% courses.forEach(course => { %>
              <option value="<%= course.id %>" <%= quiz?.course_id == course.id ? 'selected' : '' %>>
                <%= course.name %>
              </option>
              <% }) %>
            </select>
          </div>

          <div class="mb-4">
            <label class="form-label" for="description">Description</label>
            <textarea class="form-control" id="description" name="description" rows="4"
                      placeholder="Enter quiz description"><%= quiz?.description || '' %></textarea>
          </div>

          <div class="row">
            <div class="col-md-6 mb-4">
              <label class="form-label" for="score">Pass Score (%)</label>
              <input type="number" class="form-control" id="score" name="score"
                     value="<%= quiz?.score || 80 %>" min="0" max="100">
            </div>
            <div class="col-md-6 mb-4">
              <label class="form-label" for="video">Video URL</label>
              <input type="text" class="form-control" id="video" name="video"
                     value="<%= quiz?.video || '' %>" placeholder="Optional video URL">
            </div>
          </div>
        </div>
      </div>

      <!-- Questions Section (only in edit mode) -->
      <% if (action === 'edit' && quiz) { %>
      <div class="card mb-4">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="card-title mb-0">
            <i class="ri ri-list-ordered me-2"></i>Questions
            <span class="badge bg-primary ms-2"><%= quiz.questions?.length || 0 %></span>
          </h5>
          <div class="btn-group">
            <button type="button" class="btn btn-primary btn-sm" id="btnAddQuestion">
              <i class="ri ri-add-line me-1"></i>Add ABCD Question
            </button>
          </div>
        </div>
        <div class="card-body">
          <div class="question-list" id="questionList">
            <% if (quiz.questions && quiz.questions.length > 0) { %>
              <% quiz.questions.forEach((q, index) => { %>
              <div class="question-item card mb-3" data-id="<%= q.id %>">
                <div class="card-body">
                  <div class="d-flex justify-content-between align-items-start">
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center mb-2">
                        <span class="badge bg-label-primary me-2"><%= index + 1 %></span>
                        <span class="badge bg-label-secondary me-2">
                          <% if (q.type === 1) { %>ABCD<% } %>
                          <% if (q.type === 2) { %>Y/N<% } %>
                          <% if (q.type === 3) { %>Writing<% } %>
                          <% if (q.type === 4) { %>Matching<% } %>
                          <% if (q.type === 5) { %>Picture Match<% } %>
                        </span>
                      </div>
                      <h6 class="mb-2"><%= q.detail?.title || 'No title' %></h6>
                      <% if (q.type === 1 && q.detail) { %>
                      <div class="row small text-muted">
                        <div class="col-6">
                          <span class="<%= q.detail.answer_a_correct ? 'text-success fw-bold' : '' %>">
                            A: <%= q.detail.answer_a || '-' %> <%= q.detail.answer_a_correct ? '✓' : '' %>
                          </span>
                        </div>
                        <div class="col-6">
                          <span class="<%= q.detail.answer_b_correct ? 'text-success fw-bold' : '' %>">
                            B: <%= q.detail.answer_b || '-' %> <%= q.detail.answer_b_correct ? '✓' : '' %>
                          </span>
                        </div>
                        <div class="col-6">
                          <span class="<%= q.detail.answer_c_correct ? 'text-success fw-bold' : '' %>">
                            C: <%= q.detail.answer_c || '-' %> <%= q.detail.answer_c_correct ? '✓' : '' %>
                          </span>
                        </div>
                        <div class="col-6">
                          <span class="<%= q.detail.answer_d_correct ? 'text-success fw-bold' : '' %>">
                            D: <%= q.detail.answer_d || '-' %> <%= q.detail.answer_d_correct ? '✓' : '' %>
                          </span>
                        </div>
                      </div>
                      <% } %>
                    </div>
                    <div class="btn-group btn-group-sm">
                      <button type="button" class="btn btn-outline-secondary btn-move-up" title="Move Up">
                        <i class="ri ri-arrow-up-line"></i>
                      </button>
                      <button type="button" class="btn btn-outline-secondary btn-move-down" title="Move Down">
                        <i class="ri ri-arrow-down-line"></i>
                      </button>
                      <button type="button" class="btn btn-outline-primary btn-edit-question"
                              data-type="<%= q.type %>" data-id="<%= q.question_id %>" title="Edit">
                        <i class="ri ri-edit-line"></i>
                      </button>
                      <button type="button" class="btn btn-outline-danger btn-delete-question"
                              data-type="<%= q.type %>" data-id="<%= q.question_id %>" title="Delete">
                        <i class="ri ri-delete-bin-line"></i>
                      </button>
                    </div>
                  </div>
                </div>
              </div>
              <% }) %>
            <% } else { %>
            <div class="text-center py-4 text-muted" id="noQuestions">
              <i class="ri ri-question-line" style="font-size: 3rem;"></i>
              <p class="mt-2">No questions added yet</p>
            </div>
            <% } %>
          </div>
        </div>
      </div>
      <% } %>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Options -->
      <div class="card mb-4">
        <div class="card-header">
          <h5 class="card-title mb-0"><i class="ri ri-settings-3-line me-2"></i>Options</h5>
        </div>
        <div class="card-body">
          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="is_random_question" name="is_random_question" value="1"
                   <%= quiz?.is_random_question ? 'checked' : '' %>>
            <label class="form-check-label" for="is_random_question">Randomize Questions</label>
          </div>

          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="is_show_answer" name="is_show_answer" value="1"
                   <%= quiz?.is_show_answer ? 'checked' : '' %>>
            <label class="form-check-label" for="is_show_answer">Show Answers After Submit</label>
          </div>
        </div>
      </div>

      <!-- Actions -->
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0"><i class="ri ri-save-line me-2"></i>Actions</h5>
        </div>
        <div class="card-body">
          <% if (action === 'edit') { %>
          <div class="mb-3">
            <span class="badge <%= Quiz.getStatusBadgeClass(quiz.is_publish) %> fs-6">
              <%= Quiz.getStatusLabel(quiz.is_publish) %>
            </span>
          </div>
          <% } %>

          <div class="d-grid gap-2">
            <button type="submit" name="submit" value="draft" class="btn btn-outline-warning">
              <i class="ri ri-draft-line me-1"></i>Save as Draft
            </button>
            <button type="submit" name="submit" value="publish" class="btn btn-success">
              <i class="ri ri-checkbox-circle-line me-1"></i>Publish
            </button>

            <% if (action === 'edit') { %>
            <button type="submit" name="submit" value="duplicate" class="btn btn-outline-primary">
              <i class="ri ri-file-copy-line me-1"></i>Duplicate
            </button>
            <% } %>

            <a href="/settings/quiz" class="btn btn-outline-secondary">
              <i class="ri ri-arrow-left-line me-1"></i>Cancel
            </a>

            <% if (action === 'edit') { %>
            <hr>
            <form action="/settings/quiz/<%= quiz.id %>/delete" method="post" class="d-grid"
                  onsubmit="return confirm('Are you sure you want to delete this quiz?')">
              <button type="submit" class="btn btn-outline-danger">
                <i class="ri ri-delete-bin-line me-1"></i>Delete Quiz
              </button>
            </form>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>

<!-- Question Modal (Add/Edit) -->
<% if (action === 'edit') { %>
<div class="modal fade" id="questionModal" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="questionModalTitle">Add ABCD Question</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <form id="questionForm">
        <input type="hidden" id="editQuestionId" name="questionId" value="">
        <div class="modal-body">
          <div class="mb-3">
            <label class="form-label">Question <span class="text-danger">*</span></label>
            <textarea class="form-control" name="title" rows="3" required placeholder="Enter question"></textarea>
          </div>

          <div class="row">
            <div class="col-md-6 mb-3">
              <label class="form-label">Answer A</label>
              <div class="input-group">
                <input type="text" class="form-control" name="answer_a" placeholder="Answer A">
                <div class="input-group-text">
                  <input class="form-check-input mt-0" type="checkbox" name="answer_a_correct" value="1" title="Correct">
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Answer B</label>
              <div class="input-group">
                <input type="text" class="form-control" name="answer_b" placeholder="Answer B">
                <div class="input-group-text">
                  <input class="form-check-input mt-0" type="checkbox" name="answer_b_correct" value="1" title="Correct">
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Answer C</label>
              <div class="input-group">
                <input type="text" class="form-control" name="answer_c" placeholder="Answer C">
                <div class="input-group-text">
                  <input class="form-check-input mt-0" type="checkbox" name="answer_c_correct" value="1" title="Correct">
                </div>
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label class="form-label">Answer D</label>
              <div class="input-group">
                <input type="text" class="form-control" name="answer_d" placeholder="Answer D">
                <div class="input-group-text">
                  <input class="form-check-input mt-0" type="checkbox" name="answer_d_correct" value="1" title="Correct">
                </div>
              </div>
            </div>
          </div>

          <div class="form-check">
            <input class="form-check-input" type="checkbox" name="is_random" value="1" id="isRandom">
            <label class="form-check-label" for="isRandom">Randomize answer order</label>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary" id="btnSubmitQuestion">Add Question</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const quizId = '<%= quiz?.id %>';
  const modal = new bootstrap.Modal(document.getElementById('questionModal'));
  const form = document.getElementById('questionForm');
  const modalTitle = document.getElementById('questionModalTitle');
  const submitBtn = document.getElementById('btnSubmitQuestion');
  const editIdInput = document.getElementById('editQuestionId');
  let isEditMode = false;

  // Reset form
  function resetForm() {
    form.reset();
    editIdInput.value = '';
    isEditMode = false;
    modalTitle.textContent = 'Add ABCD Question';
    submitBtn.textContent = 'Add Question';
  }

  // Add Question Button
  document.getElementById('btnAddQuestion')?.addEventListener('click', function() {
    resetForm();
    modal.show();
  });

  // Edit Question Button
  document.querySelectorAll('.btn-edit-question').forEach(btn => {
    btn.addEventListener('click', async function() {
      const type = this.dataset.type;
      const id = this.dataset.id;

      if (type != 1) {
        alert('Only ABCD questions can be edited currently.');
        return;
      }

      try {
        const response = await fetch(`/settings/quiz/${quizId}/question/abcd/${id}`);
        const result = await response.json();

        if (result.success) {
          const q = result.data;
          isEditMode = true;
          editIdInput.value = id;
          modalTitle.textContent = 'Edit ABCD Question';
          submitBtn.textContent = 'Update Question';

          // Populate form
          form.querySelector('[name="title"]').value = q.title || '';
          form.querySelector('[name="answer_a"]').value = q.answer_a || '';
          form.querySelector('[name="answer_a_correct"]').checked = q.answer_a_correct == 1;
          form.querySelector('[name="answer_b"]').value = q.answer_b || '';
          form.querySelector('[name="answer_b_correct"]').checked = q.answer_b_correct == 1;
          form.querySelector('[name="answer_c"]').value = q.answer_c || '';
          form.querySelector('[name="answer_c_correct"]').checked = q.answer_c_correct == 1;
          form.querySelector('[name="answer_d"]').value = q.answer_d || '';
          form.querySelector('[name="answer_d_correct"]').checked = q.answer_d_correct == 1;
          form.querySelector('[name="is_random"]').checked = q.is_random == 1;

          modal.show();
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });
  });

  // Submit Form (Add/Update)
  form?.addEventListener('submit', async function(e) {
    e.preventDefault();

    const formData = new FormData(this);
    const data = {
      title: formData.get('title'),
      answer_a: formData.get('answer_a'),
      answer_a_correct: formData.get('answer_a_correct') ? 1 : 0,
      answer_b: formData.get('answer_b'),
      answer_b_correct: formData.get('answer_b_correct') ? 1 : 0,
      answer_c: formData.get('answer_c'),
      answer_c_correct: formData.get('answer_c_correct') ? 1 : 0,
      answer_d: formData.get('answer_d'),
      answer_d_correct: formData.get('answer_d_correct') ? 1 : 0,
      is_random: formData.get('is_random') ? 1 : 0
    };

    const questionId = editIdInput.value;
    const url = isEditMode
      ? `/settings/quiz/${quizId}/question/abcd/${questionId}`
      : `/settings/quiz/${quizId}/question/abcd`;
    const method = isEditMode ? 'PUT' : 'POST';

    try {
      const response = await fetch(url, {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result.success) {
        location.reload();
      } else {
        alert('Error: ' + result.error);
      }
    } catch (error) {
      alert('Error: ' + error.message);
    }
  });

  // Move Up Button
  document.querySelectorAll('.btn-move-up').forEach(btn => {
    btn.addEventListener('click', async function() {
      const item = this.closest('.question-item');
      const prevItem = item.previousElementSibling;

      if (prevItem && prevItem.classList.contains('question-item')) {
        item.parentNode.insertBefore(item, prevItem);
        await saveOrder();
      }
    });
  });

  // Move Down Button
  document.querySelectorAll('.btn-move-down').forEach(btn => {
    btn.addEventListener('click', async function() {
      const item = this.closest('.question-item');
      const nextItem = item.nextElementSibling;

      if (nextItem && nextItem.classList.contains('question-item')) {
        item.parentNode.insertBefore(nextItem, item);
        await saveOrder();
      }
    });
  });

  // Save order to server
  async function saveOrder() {
    const items = document.querySelectorAll('.question-item');
    const orders = [];

    items.forEach((item, index) => {
      orders.push({
        id: parseInt(item.dataset.id),
        order: index + 1
      });
    });

    try {
      const response = await fetch(`/settings/quiz/${quizId}/question/reorder`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ orders })
      });

      const result = await response.json();

      if (result.success) {
        // Update badge numbers
        items.forEach((item, index) => {
          const badge = item.querySelector('.badge.bg-label-primary');
          if (badge) badge.textContent = index + 1;
        });
      } else {
        alert('Error saving order: ' + result.error);
        location.reload();
      }
    } catch (error) {
      alert('Error saving order: ' + error.message);
      location.reload();
    }
  }

  // Delete Question
  document.querySelectorAll('.btn-delete-question').forEach(btn => {
    btn.addEventListener('click', async function() {
      if (!confirm('Are you sure you want to delete this question?')) return;

      const type = this.dataset.type;
      const id = this.dataset.id;

      try {
        const response = await fetch(`/settings/quiz/${quizId}/question/${id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ type: parseInt(type) })
        });

        const result = await response.json();

        if (result.success) {
          this.closest('.question-item').remove();
          // Update remaining badges
          document.querySelectorAll('.question-item').forEach((item, index) => {
            const badge = item.querySelector('.badge.bg-label-primary');
            if (badge) badge.textContent = index + 1;
          });
        } else {
          alert('Error: ' + result.error);
        }
      } catch (error) {
        alert('Error: ' + error.message);
      }
    });
  });
});
</script>
<% } %>

<style>
.question-item {
  transition: all 0.2s ease;
}

.question-item:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
</style>
