<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
    <li class="breadcrumb-item"><a href="/settings">Settings</a></li>
    <li class="breadcrumb-item active">Quiz</li>
  </ol>
</nav>

<!-- Stats Cards -->
<div class="row mb-4">
  <div class="col-sm-4">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="avatar avatar-lg me-3 bg-label-primary">
            <span class="avatar-initial rounded"><i class="ri ri-questionnaire-line"></i></span>
          </div>
          <div>
            <h4 class="mb-0"><%= stats?.total || 0 %></h4>
            <span class="text-muted">Total Quizzes</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-4">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="avatar avatar-lg me-3 bg-label-success">
            <span class="avatar-initial rounded"><i class="ri ri-checkbox-circle-line"></i></span>
          </div>
          <div>
            <h4 class="mb-0"><%= stats?.published || 0 %></h4>
            <span class="text-muted">Published</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-4">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="avatar avatar-lg me-3 bg-label-warning">
            <span class="avatar-initial rounded"><i class="ri ri-draft-line"></i></span>
          </div>
          <div>
            <h4 class="mb-0"><%= stats?.draft || 0 %></h4>
            <span class="text-muted">Draft</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Quiz List -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="ri ri-questionnaire-line me-2"></i>Quiz Management
    </h5>
    <a href="/settings/quiz/create" class="btn btn-primary">
      <i class="ri ri-add-line me-1"></i>Create Quiz
    </a>
  </div>

  <!-- Filters -->
  <div class="card-body border-bottom">
    <form method="get" class="row g-3">
      <div class="col-md-4">
        <div class="input-group">
          <span class="input-group-text"><i class="ri ri-search-line"></i></span>
          <input type="text" class="form-control" name="k" placeholder="Search quiz..."
                 value="<%= filters?.keyword || '' %>">
        </div>
      </div>
      <div class="col-md-3">
        <select class="form-select" name="status">
          <option value="">All Status</option>
          <option value="1" <%= filters?.status == '1' ? 'selected' : '' %>>Published</option>
          <option value="0" <%= filters?.status == '0' ? 'selected' : '' %>>Draft</option>
        </select>
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-outline-primary">
          <i class="ri ri-filter-line me-1"></i>Filter
        </button>
        <a href="/settings/quiz" class="btn btn-outline-secondary">
          <i class="ri ri-refresh-line me-1"></i>Reset
        </a>
      </div>
    </form>
  </div>

  <!-- Quiz Grid -->
  <div class="card-body">
    <% if (quizzes && quizzes.length > 0) { %>
    <div class="row g-4">
      <% quizzes.forEach(quiz => { %>
      <div class="col-md-6">
        <div class="card h-100 <%= quiz.is_publish === 0 ? 'border-warning' : '' %>">
          <div class="card-body">
            <div class="d-flex justify-content-between align-items-start mb-2">
              <h6 class="card-title mb-0">
                <a href="/settings/quiz/<%= quiz.id %>/edit" class="text-body">
                  <%= quiz.title %>
                </a>
              </h6>
              <span class="badge <%= Quiz.getStatusBadgeClass(quiz.is_publish) %>">
                <%= Quiz.getStatusLabel(quiz.is_publish) %>
              </span>
            </div>

            <p class="text-muted small mb-3">
              <i class="ri ri-book-open-line me-1"></i>
              <%= quiz.course_name || 'No Course' %>
            </p>

            <% if (quiz.description) { %>
            <p class="card-text small text-truncate-2"><%= quiz.description %></p>
            <% } %>

            <div class="d-flex justify-content-between align-items-center mt-3">
              <div class="text-muted small">
                <span class="me-3">
                  <i class="ri ri-question-line me-1"></i>
                  <%= quiz.question_count || 0 %> Questions
                </span>
                <span>
                  <i class="ri ri-percent-line me-1"></i>
                  <%= quiz.score %>% Pass
                </span>
              </div>
              <div class="btn-group btn-group-sm" role="group">
                <a href="/settings/quiz/<%= quiz.id %>/edit" class="btn btn-outline-primary" title="Edit">
                  <i class="ri ri-edit-line"></i>
                </a>
                <button type="button" class="btn btn-outline-danger btn-delete-quiz"
                        data-id="<%= quiz.id %>" title="Delete">
                  <i class="ri ri-delete-bin-line"></i>
                </button>
              </div>
              <form id="delete-form-<%= quiz.id %>" action="/settings/quiz/<%= quiz.id %>/delete" method="post" class="d-none"></form>
            </div>
          </div>
        </div>
      </div>
      <% }) %>
    </div>

    <!-- Pagination -->
    <% if (pagination && pagination.totalPages > 1) { %>
    <div class="d-flex justify-content-between align-items-center flex-wrap mt-4">
      <div class="text-muted small">
        Showing <%= ((pagination.currentPage - 1) * pagination.perPage) + 1 %> - <%= Math.min(pagination.currentPage * pagination.perPage, pagination.total) %> of <%= pagination.total %> quizzes
      </div>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item <%= pagination.currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link" href="?<%= new URLSearchParams({...query, page: 1}).toString() %>">
              <i class="ri ri-arrow-left-double-line"></i>
            </a>
          </li>
          <li class="page-item <%= pagination.currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link" href="?<%= new URLSearchParams({...query, page: pagination.currentPage - 1}).toString() %>">
              <i class="ri ri-arrow-left-s-line"></i>
            </a>
          </li>

          <%
          let startPage = Math.max(1, pagination.currentPage - 2);
          let endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
          %>

          <% for (let p = startPage; p <= endPage; p++) { %>
          <li class="page-item <%= p === pagination.currentPage ? 'active' : '' %>">
            <a class="page-link" href="?<%= new URLSearchParams({...query, page: p}).toString() %>"><%= p %></a>
          </li>
          <% } %>

          <li class="page-item <%= pagination.currentPage === pagination.totalPages ? 'disabled' : '' %>">
            <a class="page-link" href="?<%= new URLSearchParams({...query, page: pagination.currentPage + 1}).toString() %>">
              <i class="ri ri-arrow-right-s-line"></i>
            </a>
          </li>
          <li class="page-item <%= pagination.currentPage === pagination.totalPages ? 'disabled' : '' %>">
            <a class="page-link" href="?<%= new URLSearchParams({...query, page: pagination.totalPages}).toString() %>">
              <i class="ri ri-arrow-right-double-line"></i>
            </a>
          </li>
        </ul>
      </nav>
    </div>
    <% } %>

    <% } else { %>
    <div class="text-center py-5">
      <i class="ri ri-questionnaire-line" style="font-size: 4rem; color: var(--bs-secondary);"></i>
      <h5 class="mt-3">No Quizzes Found</h5>
      <p class="text-muted">Create your first quiz to get started</p>
      <a href="/settings/quiz/create" class="btn btn-primary">
        <i class="ri ri-add-line me-1"></i>Create Quiz
      </a>
    </div>
    <% } %>
  </div>
</div>

<style>
.text-truncate-2 {
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
  overflow: hidden;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.btn-delete-quiz').forEach(btn => {
    btn.addEventListener('click', function() {
      if (confirm('Are you sure you want to delete this quiz?')) {
        const id = this.dataset.id;
        document.getElementById('delete-form-' + id).submit();
      }
    });
  });
});
</script>
