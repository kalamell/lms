<!-- Breadcrumb -->
<nav aria-label="breadcrumb">
  <ol class="breadcrumb">
    <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
    <li class="breadcrumb-item active">Users</li>
  </ol>
</nav>

<!-- Stats Cards -->
<div class="row mb-4">
  <div class="col-sm-6">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="avatar avatar-lg me-3 bg-label-primary">
            <span class="avatar-initial rounded"><i class="ri ri-user-line"></i></span>
          </div>
          <div>
            <h4 class="mb-0"><%= stats?.total?.toLocaleString() || 0 %></h4>
            <span class="text-muted">Total Users</span>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="col-sm-6">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-center">
          <div class="avatar avatar-lg me-3 bg-label-warning">
            <span class="avatar-initial rounded"><i class="ri ri-shield-user-line"></i></span>
          </div>
          <div>
            <h4 class="mb-0"><%= stats?.admins?.toLocaleString() || 0 %></h4>
            <span class="text-muted">Admins</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- User List -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="card-title mb-0">
      <i class="ri ri-user-line me-2"></i>User Management
    </h5>
  </div>

  <!-- Filters -->
  <div class="card-body border-bottom">
    <form method="get" class="row g-3">
      <div class="col-md-2">
        <select class="form-select" name="company">
          <option value="lotus" <%= filters?.company == 'lotus' ? 'selected' : '' %>>Lotus</option>
          <option value="makro" <%= filters?.company == 'makro' ? 'selected' : '' %>>Makro</option>
          <option value="all" <%= filters?.company == 'all' ? 'selected' : '' %>>All Companies</option>
        </select>
      </div>
      <div class="col-md-3">
        <div class="input-group">
          <span class="input-group-text"><i class="ri ri-search-line"></i></span>
          <input type="text" class="form-control" name="k" placeholder="Search..."
                 value="<%= filters?.keyword || '' %>">
        </div>
      </div>
      <div class="col-md-2">
        <select class="form-select" name="format_id">
          <option value="">All Formats</option>
          <% formats.forEach(format => { %>
          <option value="<%= format.id %>" <%= filters?.formatId == format.id ? 'selected' : '' %>>
            <%= format.name %>
          </option>
          <% }) %>
        </select>
      </div>
      <div class="col-md-2">
        <select class="form-select" name="status">
          <option value="">All Status</option>
          <option value="1" <%= filters?.status == '1' ? 'selected' : '' %>>Active</option>
          <option value="0" <%= filters?.status == '0' ? 'selected' : '' %>>Inactive</option>
        </select>
      </div>
      <div class="col-md-3">
        <button type="submit" class="btn btn-outline-primary">
          <i class="ri ri-filter-line me-1"></i>Filter
        </button>
        <a href="/user" class="btn btn-outline-secondary">
          <i class="ri ri-refresh-line me-1"></i>Reset
        </a>
      </div>
    </form>
  </div>

  <!-- User Table -->
  <div class="card-body">
    <% if (users && users.length > 0) { %>
    <div class="table-responsive">
      <table class="table table-hover">
        <thead>
          <tr>
            <th>Employee ID</th>
            <th>Name</th>
            <th>Company</th>
            <th>Position</th>
            <th>Department</th>
            <th>Type</th>
            <th>Status</th>
            <th class="text-center">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% users.forEach(user => { %>
          <tr>
            <td>
              <a href="/user/<%= user.id %>" class="fw-medium">
                <%= user.employee_id || '-' %>
              </a>
            </td>
            <td>
              <div class="d-flex align-items-center">
                <div class="avatar avatar-sm me-2">
                  <% if (user.avatar || user.avatar_path) { %>
                  <img src="<%= User.getAvatarUrl(user) %>" alt="" class="rounded-circle">
                  <% } else { %>
                  <span class="avatar-initial rounded-circle bg-label-primary">
                    <%= (user.first_name || user.name_thai || 'U').charAt(0).toUpperCase() %>
                  </span>
                  <% } %>
                </div>
                <div>
                  <div><%= User.getDisplayName(user) %></div>
                  <small class="text-muted"><%= user.email || '' %></small>
                </div>
              </div>
            </td>
            <td>
              <% if (user.company === 'makro') { %>
              <span class="badge bg-label-warning">Makro</span>
              <% } else { %>
              <span class="badge bg-label-success">Lotus</span>
              <% } %>
            </td>
            <td><%= user.position || '-' %></td>
            <td><%= user.department || '-' %></td>
            <td>
              <span class="badge <%= User.getTypeBadgeClass(user.type) %>">
                <%= User.getTypeLabel(user.type) %>
              </span>
            </td>
            <td>
              <span class="badge <%= User.getStatusBadgeClass(user) %>">
                <%= User.getStatusLabel(user) %>
              </span>
            </td>
            <td class="text-center">
              <div class="dropdown">
                <button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                  <i class="ri ri-more-2-fill"></i>
                </button>
                <ul class="dropdown-menu dropdown-menu-end">
                  <li>
                    <a class="dropdown-item" href="/user/<%= user.id %>">
                      <i class="ri ri-book-open-line me-2"></i>ดูผลการเรียน
                    </a>
                  </li>
                  <li>
                    <a class="dropdown-item" href="/user/<%= user.id %>/edit">
                      <i class="ri ri-edit-line me-2"></i>Edit
                    </a>
                  </li>
                  <li><hr class="dropdown-divider"></li>
                  <li>
                    <a class="dropdown-item text-danger btn-delete-user" href="#" data-id="<%= user.id %>">
                      <i class="ri ri-delete-bin-line me-2"></i>Delete
                    </a>
                  </li>
                </ul>
              </div>
              <form id="delete-form-<%= user.id %>" action="/user/<%= user.id %>/delete" method="post" class="d-none"></form>
            </td>
          </tr>
          <% }) %>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <% if (pagination && pagination.totalPages > 1) { %>
    <div class="d-flex justify-content-between align-items-center flex-wrap mt-4">
      <div class="text-muted small">
        Showing <%= ((pagination.currentPage - 1) * pagination.perPage) + 1 %> - <%= Math.min(pagination.currentPage * pagination.perPage, pagination.total) %> of <%= pagination.total.toLocaleString() %> users
      </div>
      <nav>
        <ul class="pagination pagination-sm mb-0">
          <li class="page-item <%= pagination.currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link" href="?<%= new URLSearchParams({...query, page: 1}).toString() %>">
              <i class="ri ri-arrow-left-double-line"></i>
            </a>
          </li>
          <li class="page-item <%= pagination.currentPage === 1 ? 'disabled' : '' %>">
            <a class="page-link" href="?<%= new URLSearchParams({...query, page: pagination.currentPage - 1}).toString() %>">
              <i class="ri ri-arrow-left-s-line"></i>
            </a>
          </li>

          <%
          let startPage = Math.max(1, pagination.currentPage - 2);
          let endPage = Math.min(pagination.totalPages, pagination.currentPage + 2);
          %>

          <% for (let p = startPage; p <= endPage; p++) { %>
          <li class="page-item <%= p === pagination.currentPage ? 'active' : '' %>">
            <a class="page-link" href="?<%= new URLSearchParams({...query, page: p}).toString() %>"><%= p %></a>
          </li>
          <% } %>

          <li class="page-item <%= pagination.currentPage === pagination.totalPages ? 'disabled' : '' %>">
            <a class="page-link" href="?<%= new URLSearchParams({...query, page: pagination.currentPage + 1}).toString() %>">
              <i class="ri ri-arrow-right-s-line"></i>
            </a>
          </li>
          <li class="page-item <%= pagination.currentPage === pagination.totalPages ? 'disabled' : '' %>">
            <a class="page-link" href="?<%= new URLSearchParams({...query, page: pagination.totalPages}).toString() %>">
              <i class="ri ri-arrow-right-double-line"></i>
            </a>
          </li>
        </ul>
      </nav>
    </div>
    <% } %>

    <% } else { %>
    <div class="text-center py-5">
      <i class="ri ri-user-line" style="font-size: 4rem; color: var(--bs-secondary);"></i>
      <h5 class="mt-3">No Users Found</h5>
      <p class="text-muted">Try adjusting your search or filter criteria</p>
    </div>
    <% } %>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  document.querySelectorAll('.btn-delete-user').forEach(btn => {
    btn.addEventListener('click', function(e) {
      e.preventDefault();
      if (confirm('Are you sure you want to delete this user?')) {
        const id = this.dataset.id;
        document.getElementById('delete-form-' + id).submit();
      }
    });
  });
});
</script>
